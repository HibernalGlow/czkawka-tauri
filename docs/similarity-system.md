# Czkawka 相似度系统详解

## 概述

Czkawka 使用汉明距离（Hamming Distance）来衡量图像相似度。汉明距离是两个哈希值之间不同位数的计数，数值越小表示图像越相似。

## 核心概念

### 1. 图像哈希
- Czkawka 将每个图像转换为一个哈希值（指纹）
- 支持多种哈希算法：Mean、Gradient、VertGradient、DoubleGradient、BlockHash、Median
- 支持多种哈希大小：8x8、16x16、32x32、64x64

### 2. 汉明距离
- 汉明距离 = 两个哈希值中不同位的数量
- 距离为 0 = 完全相同
- 距离越大 = 差异越大

### 3. 相似度阈值控制
用户通过滑条设置最大汉明距离阈值（0-40），只有汉明距离小于等于此值的图像对才会被检测为相似。

## 相似度等级分类

系统根据汉明距离将相似度分为以下等级：

| 等级 | 英文 | 中文 | 8x8阈值 | 16x16阈值 | 32x32阈值 | 64x64阈值 |
|------|------|------|---------|-----------|-----------|-----------|
| Original | Original | 原图 | 0 | 0 | 0 | 0 |
| Very High | Very High | 极高 | ≤1 | ≤2 | ≤4 | ≤6 |
| High | High | 高 | ≤2 | ≤5 | ≤10 | ≤20 |
| Medium | Medium | 中等 | ≤5 | ≤15 | ≤20 | ≤40 |
| Small | Small | 较小 | ≤7 | ≤30 | ≤40 | ≤40 |
| Very Small | Very Small | 极小 | ≤14 | ≤40 | ≤40 | ≤40 |
| Minimal | Minimal | 极微 | ≤40 | ≤40 | ≤40 | ≤40 |

## 哈希大小的影响

### 8x8 哈希（64位）
- 最快的计算速度
- 最粗略的相似度检测
- 适合快速扫描大量图像

### 16x16 哈希（256位）
- 默认设置，平衡精度和性能
- 适合大多数用例

### 32x32 哈希（1024位）
- 更高的精度
- 较慢的计算速度

### 64x64 哈希（4096位）
- 最高的精度
- 最慢的计算速度
- 适合对精度要求极高的场景

## 实际示例

假设使用 16x16 哈希：

1. **极高相似度（汉明距离 1-2）**
   - 可能是同一张图的轻微编辑
   - 例如：添加水印、轻微裁剪、格式转换

2. **高相似度（汉明距离 3-5）**
   - 明显相关但有一定差异的图像
   - 例如：同一场景的不同角度、轻微色彩调整

3. **中等相似度（汉明距离 6-15）**
   - 结构相似但细节不同
   - 例如：同类物体的不同实例、相同构图的不同内容

4. **较小相似度（汉明距离 16-30）**
   - 有一定相关性但差异较大
   - 例如：相同主题但不同场景

5. **极小/极微相似度（汉明距离 31-40）**
   - 微弱的相关性
   - 可能是误检，需要人工确认

## 使用建议

### 参数调优
1. **快速扫描**：使用 8x8 哈希，阈值设为 5-10
2. **平衡模式**：使用 16x16 哈希，阈值设为 10-15
3. **精确模式**：使用 32x32 或 64x64 哈希，阈值设为 15-25

### 注意事项
1. 哈希大小越大，计算时间越长，但精度越高
2. 阈值设置过低可能漏检相似图像
3. 阈值设置过高可能产生大量误检
4. 建议先用较小的哈希和较低的阈值进行初步扫描

## 界面功能

### 鼠标悬停提示
在相似度列或筛选器中，将鼠标悬停在相似度等级上会显示详细的汉明距离阈值信息，包含所有哈希大小下的对应值。

### 筛选功能
可以根据相似度等级筛选结果，只显示特定相似度范围的图像组。

## 技术实现

相似度分级的核心代码位于：
- `czkawka_core/src/tools/similar_images.rs` - 后端算法实现
- `ui/src/views/similar-images.tsx` - 前端显示逻辑
- `ui/src/views/file-filter.tsx` - 筛选功能实现

相似度字符串生成函数 `get_string_from_similarity` 根据汉明距离和哈希大小返回对应的等级标识符。
